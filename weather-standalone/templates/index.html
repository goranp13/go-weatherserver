<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ¤ï¸ Vremenska prognoza Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ğŸŒ¤ï¸ Vremenska prognoza</h1>
            <div class="controls">
                <button id="darkModeToggle" class="theme-toggle" title="Toggle dark mode">ğŸŒ™</button>
            </div>
        </div>
        <div class="refresh-status" id="refreshStatus">Zadnja osvjeÅ¾avanja: upravo sada</div>
    </div>

    <div class="container">
        <div class="locations-grid" id="locationsGrid">
            <div class="weather-card" data-city="zagreb">
                <div class="location-name">Zagreb</div>
                <div class="weather-emoji">â˜ï¸</div>
                <div class="temp">-Â°C</div>
                <div class="condition">-</div>
                <div class="details">
                    <div class="detail-item">ğŸ’¨ - km/h</div>
                    <div class="detail-item">ğŸ’§ -%</div>
                </div>
                <button class="forecast-btn" onclick="event.stopPropagation(); loadForecast('zagreb')">Prognoza od 5 dana</button>
            </div>

            <div class="weather-card" data-city="split">
                <div class="location-name">Split</div>
                <div class="weather-emoji">â˜€ï¸</div>
                <div class="temp">-Â°C</div>
                <div class="condition">-</div>
                <div class="details">
                    <div class="detail-item">ğŸ’¨ - km/h</div>
                    <div class="detail-item">ğŸ’§ -%</div>
                </div>
                <button class="forecast-btn" onclick="event.stopPropagation(); loadForecast('split')">Prognoza od 5 dana</button>
            </div>

            <div class="weather-card" data-city="dubrovnik">
                <div class="location-name">Dubrovnik</div>
                <div class="weather-emoji">â˜€ï¸</div>
                <div class="temp">-Â°C</div>
                <div class="condition">-</div>
                <div class="details">
                    <div class="detail-item">ğŸ’¨ - km/h</div>
                    <div class="detail-item">ğŸ’§ -%</div>
                </div>
                <button class="forecast-btn" onclick="event.stopPropagation(); loadForecast('dubrovnik')">Prognoza od 5 dana</button>
            </div>

            <div class="weather-card" data-city="rijeka">
                <div class="location-name">Rijeka</div>
                <div class="weather-emoji">ğŸŒ§ï¸</div>
                <div class="temp">-Â°C</div>
                <div class="condition">-</div>
                <div class="details">
                    <div class="detail-item">ğŸ’¨ - km/h</div>
                    <div class="detail-item">ğŸ’§ -%</div>
                </div>
                <button class="forecast-btn" onclick="event.stopPropagation(); loadForecast('rijeka')">Prognoza od 5 dana</button>
            </div>

            <div class="weather-card" data-city="zadar">
                <div class="location-name">Zadar</div>
                <div class="weather-emoji">â›…</div>
                <div class="temp">-Â°C</div>
                <div class="condition">-</div>
                <div class="details">
                    <div class="detail-item">ğŸ’¨ - km/h</div>
                    <div class="detail-item">ğŸ’§ -%</div>
                </div>
                <button class="forecast-btn" onclick="event.stopPropagation(); loadForecast('zadar')">Prognoza od 5 dana</button>
            </div>

            <div class="weather-card" data-city="osijek">
                <div class="location-name">Osijek</div>
                <div class="weather-emoji">-</div>
                <div class="temp">-Â°C</div>
                <div class="condition">-</div>
                <div class="details">
                    <div class="detail-item">ğŸ’¨ - km/h</div>
                    <div class="detail-item">ğŸ’§ -%</div>
                </div>
                <button class="forecast-btn" onclick="event.stopPropagation(); loadForecast('osijek')">Prognoza od 5 dana</button>
            </div>
        </div>
    </div>

    <script>
        console.log('Inline script loaded - VERSION WITH FORECAST');
        
        // Test that loadForecast function exists
        console.log('loadForecast function:', typeof loadForecast);
        
        // Load all cities data
        function loadAllCitiesData() {
            console.log('Starting to load fresh data for all cities...');
            const cities = ['zagreb', 'split', 'dubrovnik', 'rijeka', 'zadar', 'osijek'];
            
            cities.forEach(city => {
                const url = '/api/weather/' + city;
                console.log('Fetching:', url);
                
                fetch(url)
                    .then(response => {
                        console.log('Response received for', city, 'status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Data received for', city, ':', data);
                        
                        // Update the card
                        const card = document.querySelector(`[data-city="${city}"]`);
                        if (card && data.Current) {
                            const tempEl = card.querySelector('.temp');
                            const conditionEl = card.querySelector('.condition');
                            const emojiEl = card.querySelector('.weather-emoji');
                            const detailItems = card.querySelectorAll('.detail-item');
                            
                            if (tempEl) tempEl.textContent = data.Current.Temperature + 'Â°C';
                            if (conditionEl) conditionEl.textContent = data.Current.Condition;
                            if (emojiEl) emojiEl.textContent = data.Current.Emoji;
                            if (detailItems[0]) detailItems[0].textContent = 'ğŸ’¨ ' + data.Current.WindSpeed + ' km/h';
                            if (detailItems[1]) detailItems[1].textContent = 'ğŸ’§ ' + data.Current.Humidity + '%';
                            
                            console.log('âœ“ Card updated for', city);
                        }
                    })
                    .catch(err => {
                        console.error('Failed to load data for', city, ':', err);
                        const card = document.querySelector(`[data-city="${city}"]`);
                        if (card) {
                            const tempEl = card.querySelector('.temp');
                            const conditionEl = card.querySelector('.condition');
                            if (tempEl) tempEl.textContent = 'N/A';
                            if (conditionEl) conditionEl.textContent = 'Data unavailable';
                        }
                    });
            });
        }
        
        // Load forecast function for 5-day forecast buttons
        function loadForecast(location) {
            console.log('Loading forecast for', location);
            fetch('/api/forecast/' + location)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Forecast data received for', location, ':', data);
                    let cityName = location.charAt(0).toUpperCase() + location.slice(1);
                    let msg = 'Prognoza od 5 dana za ' + cityName + ':\n\n';
                    data.Forecast.forEach(day => {
                        msg += day.Date + ': ' + day.Emoji + ' ' + day.High + 'Â°C / ' + day.Low + 'Â°C - ' + day.Condition + '\n';
                    });
                    alert(msg);
                })
                .catch(err => {
                    console.error('loadForecast failed:', err);
                    alert('GreÅ¡ka pri uÄitavanju prognoze');
                });
        }
        
        // Add click listeners to weather cards
        function initCardClickListeners() {
            const cards = document.querySelectorAll('.weather-card');
            cards.forEach(card => {
                card.addEventListener('click', function() {
                    const city = this.getAttribute('data-city');
                    if (city) {
                        fetch('/api/weather/' + city)
                            .then(r => r.json())
                            .then(data => {
                                const msg = `${data.Current.Location}\n` +
                                      `Temperatura: ${data.Current.Temperature}Â°C\n` +
                                      `Stanje: ${data.Current.Condition}\n` +
                                      `OsjeÄ‡a se kao: ${data.Current.FeelsLike}Â°C\n` +
                                      `Vlaga: ${data.Current.Humidity}%\n` +
                                      `Vjetar: ${data.Current.WindSpeed} km/h\n\n` +
                                      `${data.Current.DramaticMessage}`;
                                alert(msg);
                            })
                            .catch(err => {
                                console.error('loadWeather failed:', err);
                                alert('GreÅ¡ka pri uÄitavanju podataka');
                            });
                    }
                });
            });
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOM ready');
                initCardClickListeners();
                loadAllCitiesData();
            });
        } else {
            console.log('DOM already ready');
            initCardClickListeners();
            loadAllCitiesData();
        }
        
        window.addEventListener('beforeunload', function() {
            fetch('/shutdown', { keepalive: true });
        });
    </script>
    </body>
</html>
